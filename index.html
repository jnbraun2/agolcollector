<!DOCTYPE html>
<html>

<head>
    <!--meta for the browswer to allow for mobile first design-->
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    
    <title>Travel Intentions: Where do you want to travel? </title>
    

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        .addRecordBtn {
            position: absolute;
            z-index: 10;
            top: 10px;
            right: 10px;
            background-color: #fb8197;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
        }

        .addRecordBtn:hover {
            background-color: #ce566c;
        }

        #races-filter {
            height: 100%;
            width: 150px;
            visibility: hidden;
        }

        .race-item {
            width: 100%;
            padding: 10px 10px;
            text-align: center;
            vertical-align: baseline;
            cursor: pointer;
            height: 45px;
        }

        .race-item:focus {
            background-color: dimgrey;
        }

        .race-item:hover {
            background-color: dimgrey;
        }


    </style>

    <!--importing the css and libraries for esri.js-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.26/"></script>

    <!--loading the modules-->
    <script>
        require([
            "esri/config", 
            "esri/Map", 
            "esri/views/MapView", 
            "esri/widgets/Locate", 
            "esri/layers/FeatureLayer", 
            "esri/widgets/Search",
            "esri/portal/Portal",
            "esri/widgets/BasemapGallery",
            "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
            "esri/widgets/Expand",
            "esri/core/reactiveUtils",
            "esri/layers/GroupLayer",
            "esri/widgets/LayerList",
            "esri/widgets/Slider"
        ], (esriConfig, Map, MapView, Locate, FeatureLayer, Search, Portal, BasemapGallery, PortalBasemapsSource, Expand, reactiveUtils, GroupLayer, LayerList, Slider) => {
            
            //adding in API key
            esriConfig.apiKey="AAPK757f4438013a4af08cc1a774d3788db9qSAv4TlOSeFWIJ1OIl6RyxaLb7U5rO_-tyazPZqw99vrEKIHVQ3Twlh9HvLom22T";
            ////https://xiaoguaishou0202yy.github.io/*


            const portal = new Portal();

            // source for basemaps from a portal group
            // containing basemaps with different projections
            const source = new PortalBasemapsSource({
                portal,
                query: {
                    id: "bdb9d65e0b5c480c8dcc6916e7f4e099"
                }
            });

            let raceLayerView;


            // Create layer showing sample data of the United States.
            const uLayer = new FeatureLayer({
                url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Continents/FeatureServer",
                title: "Unique Color",
            });

            // Create layer showing sample census data of the United States.
            // Set visibility to false so it's not visible on startup.
            const gLayer = new FeatureLayer({
                url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Continents/FeatureServer",
                title: "Gradient Color",
                visible: false
            });

            // Create GroupLayer with the two MapImageLayers created above
            // as children layers.
            const ctntGroupLayer = new GroupLayer({
                title: "World Continents",
                visible: false,
                visibilityMode: "exclusive",
                layers: [uLayer, gLayer],
                opacity: 0.75
            });


            const map = new Map({

                basemap: "arcgis-streets-night",
                layers: [ctntGroupLayer]
            });

            const view = new MapView({
                container: "viewDiv", // Reference to the DOM node that will contain the view
                map: map, // References the map object
                center: [128, 34],
                zoom: 2
            });



        // Creates actions in the LayerList.
        async function defineActions(event) {
            const { item } = event;

            await item.layer.when();

            if (item.title === "US Demographics") {

                item.actionsSections = [
                [
                    {
                    title: "Go to full extent",
                    icon: "zoom-out-fixed",
                    id: "full-extent"
                    },
                    {
                    title: "Layer information",
                    icon: "information",
                    id: "information"
                    }
                ],
                [
                    {
                    title: "Increase opacity",
                    icon: "chevron-up",
                    id: "increase-opacity"
                    },
                    {
                    title: "Decrease opacity",
                    icon: "chevron-down",
                    id: "decrease-opacity"
                    }
                ]
                ];
            }

            // Adds a slider for updating a group layer's opacity
            if (item.children.length > 1 && item.parent) {
                const slider = new Slider({
                min: 0,
                max: 1,
                precision: 2,
                values: [1],
                visibleElements: {
                    labels: true,
                    rangeLabels: true
                }
                });

                item.panel = {
                content: slider,
                icon: "sliders-horizontal",
                title: "Change layer opacity"
                };

                // Watch the slider's values array and update the layer's opacity
                reactiveUtils.watch(
                () => slider.values.map((value) => value),
                (values) => (item.layer.opacity = values[0])
                );
            }
        }

        view.when(() => {
            const layerList = new LayerList({
                view: view,
                // executes for each ListItem in the LayerList
                listItemCreatedFunction: defineActions
            });

            // Event listener that fires each time an action is triggered
            layerList.on("trigger-action", (event) => {
                // The layer visible in the view at the time of the trigger.
                const visibleLayer = USALayer.visible ? USALayer : censusLayer;

                // Capture the action id.
                const id = event.action.id;

                if (id === "full-extent") {
                // If the full-extent action is triggered then navigate
                // to the full extent of the visible layer
                view.goTo(visibleLayer.fullExtent).catch((error) => {
                    if (error.name != "AbortError") {
                    console.error(error);
                    }
                });
                } else if (id === "information") {
                // If the information action is triggered, then
                // open the item details page of the service layer
                window.open(visibleLayer.url);
                } else if (id === "increase-opacity") {
                // If the increase-opacity action is triggered, then
                // increase the opacity of the GroupLayer by 0.25
                if (ctntGroupLayer.opacity < 1) {
                    ctntGroupLayer.opacity += 0.25;
                }
                } else if (id === "decrease-opacity") {
                // If the decrease-opacity action is triggered, then
                // decrease the opacity of the GroupLayer by 0.25
                if (ctntGroupLayer.opacity > 0) {
                    ctntGroupLayer.opacity -= 0.25;
                }
                }
            });

            // Add widget to the top right corner of the view
            view.ui.add(layerList, "bottom-left");
        });








            const bgExpand = new Expand({
                view,
                content: new BasemapGallery({ source, view }),
                expandIcon: "basemap"
            });
            view.ui.add(bgExpand, "bottom-right");

            reactiveUtils.watch(() => view.spatialReference, (spatialReference)=> {
                document.getElementById("srDiv").innerHTML = `view.spatialReference.wkid = <b>${spatialReference.wkid}</b>`;
            });

            // Define a pop-up for usaeduLayer
            const popupPOI = {
            "title": "I Want To Travel Here!",
            "content": "<b>Nickname:</b> {your_nickname}<br><b>Home Country:</b> {where_are_you_from}<br><b>Recommended Cities:</b> {which_cities_in_your_country_do}<br><b>Self-Defined Race:</b> {what_racial_or_ethnic_groups_de}<br>"
            }

            const locateBtn = new Locate({
                view: view
            });

            // Add the locate widget to the top left corner of the view
            view.ui.add(locateBtn, {
                position: "top-left"
            });

            // Create featurelayer from feature service 
            const layer = new FeatureLayer({ 
                // URL to the service 
                url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_baa11953da754e559d9154ea31915630_results/FeatureServer", //Your item URL Goes Here
                //adding the popup here
                outFields: ["your_nickname","where_are_you_from","which_cities_in_your_country_do","what_racial_or_ethnic_groups_de"],
                popupTemplate: popupPOI
            
            });

            map.add(layer);

            const searchWidget = new Search({
                view: view
            });
            // Adds the search widget below other elements in
            // the top left corner of the view
            view.ui.add(searchWidget, {
                position: "bottom-left",
                index: 2
            }); 


            const racesNodes = document.querySelectorAll(`.race-item`);
            const racesElement = document.getElementById("races-filter");

            // click event handler for races choices
            racesElement.addEventListener("click", filterByRace);

            function filterByRace(event) {
            const selectedRace = event.target.getAttribute("data-race");
            raceLayerView.filter = {
                where: "what_racial_or_ethnic_groups_de = '" + selectedRace + "'"
            };
            }

            view.whenLayerView(layer).then((layerView) => {
            // flash flood warnings layer loaded
            // get a reference to the flood warnings layerview
                raceLayerView = layerView;

                // set up UI items
                racesElement.style.visibility = "visible";
                const racesExpand = new Expand({
                    view: view,
                    content: racesElement,
                    expandIcon: "layer-filter",
                    group: "top-left"
                });

                //clear the filters when user closes the expand widget
                reactiveUtils.when(
                    () => !racesExpand.expanded,
                    () => {
                    raceLayerView.filter = null;
                    }
                );
                view.ui.add(racesExpand, "top-left");
            });

            

        });
    </script>
</head>

<body>
    <a href="https://arcg.is/09biiL"target="_blank" class="addRecordBtn">Add Record</a>

    <div id="races-filter" class="esri-widget">
        <div class="race-item visible-race" data-race="White or Caucasian">White or Caucasian</div>
        <div class="race-item visible-race" data-race="Black or African American">Black or African American</div>
        <div class="race-item visible-race" data-race="Latino or Hispanic">Latino or Hispanic</div>
        <div class="race-item visible-race" data-race="Native American or Alaskan Native">Native American or Alaskan Native</div>
        <div class="race-item visible-race" data-race="Asian">Asian</div>
        <div class="race-item visible-race" data-race="Pacific Islander or Hawaiian">Pacific Islander or Hawaiian</div>
        <div class="race-item visible-race" data-race="Multiracial or Biracial">Multiracial or Biracial</div>
        <div class="race-item visible-race" data-race="A race/ethnicity not listed here">A race/ethnicity not listed here</div>
    </div>

    <div id="viewDiv"></div>

    <div id="srDiv" class="esri-widget"></div>
</body>
</html>

